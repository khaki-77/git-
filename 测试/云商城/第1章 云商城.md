# 第1章	云商城业务+架构学习和环境准备

## 课程目标

**1、电商知识学习**

​	1).了解电商前景

​	2).掌握电商模式（O2O、C2C、B2B、B2B2C）

**2、掌握云商城业务场景**

​	1).云商城业务介绍

​	2).云商城业务功能学习

**3、掌握云商城架构设计**

​	1).前后端分离开发模式学习

​	2).云商城架构设计

​	3).云商城技术栈讲解

**4、云商城表结构讲解**

​	1).云商城业务数据库介绍

​	2).云商城表结构讲解

**5、工程搭建**

​	1).微服务项目结构介绍

​	2).微服务工程模块搭建

**6、云商城品牌增删改查实现**

​	1).基于MyBatisPlus实现品牌增删改

​	2).基于MyBatisPlus实现品牌条件搜索



## 1 电商知识学习

​	这一节主要讲解电子商务行业前景，并且带大家了解一下天猫双十一的交易，然后带大家学习一下电商主流模式。学完后会对电商前景有个清晰的认识，能快速定位电商平台的模式。



### 1.1 行业分析

​	2019年我国电子商务交易额为38.24万亿元，其中网购尤为突出，网上零售额为15.63万亿元，网购已经成为了国内绝大多数人的购物方式。
​	受到疫情影响，电子商务在生活中充当了更重要的角色，大数据分析，2020年电子商务交易额将达到45万亿，2021年电子商务交易额将突破50万亿。电子商务的前景非常可观，非常值得学习。

![1602386880917](images\1602386880917.png)



​	国内主流电商平台有淘宝、天猫、京东，每到双十一国内主流电商平台成交额惊人，2019年天猫双十一成交总额为2684亿，1分钟就破了100亿，网站流量惊人。京东2019年双十一成交总额为2044亿。

![1602386591012](images\1602386591012.png)





### 1.2 主流电商模式

​	当前主流电商模式有B2B，C2C，O2O，B2B2C，我们对这些电商模式进行一个简单了解，方便以后大家做项目对项目的定位的一个清晰认知。

​	**B2B:**Business to Business，交易双方的身份都是商家，也就是商家将商品卖给商家，类似采购、批发类购物，国内代表性网站阿里巴巴批发网(1688)。

![1602387406471](images\1602387406471.png)



​	**C2C:**Customer to Customer，交易双方都可以是个人，比如淘宝网。

![1602387529662](images\1602387529662.png)



​	**O2O:**Online To Offline，线上线下模式，典型的代表饿了么，在线上支付了，在线下获取商品。

![1602387586406](images\1602387586406.png)



​	**B2B2C:**大型的电商平台，允许商家入驻，允许会员在平台买卖商品，京东和天猫都属于这类型网站。

![1602387678328](images\1602387678328.png)



## 2 云商城业务场景

​	这节内容主要从宏观层面学习云商城的业务场景，有助于大家理解云商城的业务结构。



### 2.1 业务学习

​	云商城是基于SpringCloud Alibaba技术栈研发的B2C电商平台，平台拥有核心的电商业务功能。运营商在后台管理商品，前台能通过搜索引擎实时搜索到最新商品，用户注册后可以直接在平台购买商品，并通过微信支付实现线上支付。用户还能参与平台秒杀抢购，并实现线上支付秒杀商品。



### 2.2 功能学习

1）商品管理

![1602398408279](images\1602398408279.png)



2）商城首页

![1602859178209](images\1602859178209.png)



3）海量商品实时搜索

![1602859217407](images\1602859217407.png)



4）商品及时秒杀

![1602859242268](images\1602859242268.png)



5）购物车管理

![1602859290613](images\1602859290613.png)



6）在线微信支付

![1602859334557](images\1602859334557.png)





## 3 云商城架构设计

### 3.1 前后端分离

​	我们过去开发一套系统，前端、后端都需要协同工作，很多时候分工不明确、责任不清晰，沟通成本大幅增加。为了提升开发效率、降低沟通成本，前后端分离的模式应运而生，前后端分离的开发模式会让各组开发人员工作更专注，沟通只需要通过前期沟通好的开发文档进行开发即可。开发流程如下图：

![1602393247864](images\1602393247864.png)



**Swagger的使用：**

编写Swagger接口，可以用Swagger Editor，地址：<https://editor.swagger.io/>

![1602921160056](images\1602921160056.png)



接口编写好了，可以导出到本地，用`swagger-ui`展示，下载地址：<https://swagger.io/tools/swagger-ui/>

![1602919512994](images\1602919512994.png)



在`资料/swagger-ui-master环境配置/Swagger配置.md`中记录了`swagger-ui`安装流程,`swagger-ui`也已经下载完成，在`资料/swagger-ui-master`中。

安装好后，执行如下命令启动swagger-ui：

```
hs -p 500
```

启动后，访问swagger-ui地址：

```
http://127.0.0.1:500/dist/index.html
```

效果如下：

![1602919900615](images\1602919900615.png)



**Swagger代码生成器：**

很多时候，我们没法快速开发完所有功能，但是有很多功能基本都是增删改查，我们可以利用工具先将增删改查的通用Swagger Api生成好，后面直接在对应基础上更改就可以了。

给大家提供了Swagger代码生成器，在`资料/swagger代码生成器`目录下，将工程`swagger-json`导入到IDEA中，就可以使用它生成Swagger Api的JSON了。



application.properties的配置如下：

```properties
#swagger的路径，相对当前项目的路径
swaggerpath=com.gupaoedu.swaggerui
#响应封装对象名字，默认为RespResult
#respbean=RespResult
#多条件搜索路径，默认：/search
#search=/find
#多条件搜索+分页，默认：/search/{page}/{size}   {size}表示路径参数
#pagesearch=/find/{page}/{size}
#生成的文件名字，默认swagger.json
filename=goods.json
#数据源配置
url=jdbc:mysql://192.168.100.130:3306/shop_goods
uname=root
pwd=123456
driver=com.mysql.jdbc.Driver
```



生成后，将json文件拷贝到`swagger-ui-master\json`中，并在`swagger-ui-master\dist\index.html`中添加该项目选项，代码如下：

```html
<div id="cgpj">
	所有项目:
	<select onchange="change(this.value)" id="pj">
		<option value="http://127.0.0.1:500/json/goods.json">商品服务</option>
		<option value="http://127.0.0.1:500/json/order.json">订单服务</option>
		<option value="http://127.0.0.1:500/json/user.json">用户服务</option>
		<option value="http://127.0.0.1:500/json/seckill.json">秒杀服务</option>
	</select>
</div>
```



再重新刷新swaggerui，就可看到效果。





### 3.2 架构设计

![1602391603063](images\1602391603063.png)

​	云商城采用了当前主流的微服务技术架构，微服务技术栈采用了当前主流的`SpringCloud Alibaba`技术栈，从接入层、网关层、服务层、数据同步、服务治理、数据处理、第三方接口多个方面进行了精心设计，技术经过了8次挑选、优中选优，最终打造了一套全网最优质的的微服务商城架构体系，解决了大型微服务电商应用中绝大多数难点、痛点问题。





## 4 云商城表结构

### 4.1 商品数据库

品牌表：`brand`

```sql
CREATE TABLE `brand` (
  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT '品牌id',
  `name` varchar(100) NOT NULL COMMENT '品牌名称',
  `image` varchar(1000) DEFAULT '' COMMENT '品牌图片地址',
  `initial` varchar(1) DEFAULT '' COMMENT '品牌的首字母',
  `sort` int(11) DEFAULT NULL COMMENT '排序',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=325475 DEFAULT CHARSET=utf8 COMMENT='品牌表';
```



商品分类表：`category`

```sql
CREATE TABLE `category` (
  `id` int(20) NOT NULL AUTO_INCREMENT COMMENT '分类ID',
  `name` varchar(50) DEFAULT NULL COMMENT '分类名称',
  `sort` int(11) DEFAULT NULL COMMENT '排序',
  `parent_id` int(20) DEFAULT NULL COMMENT '上级ID',
  PRIMARY KEY (`id`),
  KEY `parent_id` (`parent_id`)
) ENGINE=InnoDB AUTO_INCREMENT=11177 DEFAULT CHARSET=utf8 COMMENT='商品类目';
```



品牌分类关联表：`category_brand`

```sql
CREATE TABLE `category_brand` (
  `category_id` int(11) NOT NULL COMMENT '分类ID',
  `brand_id` int(11) NOT NULL COMMENT '品牌ID',
  PRIMARY KEY (`brand_id`,`category_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
```



商品属性表：`sku_attribute`

```sql
CREATE TABLE `sku_attribute` (
  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT 'ID',
  `name` varchar(50) DEFAULT NULL COMMENT '属性名称',
  `options` varchar(2000) DEFAULT NULL COMMENT '属性选项',
  `sort` int(11) DEFAULT NULL COMMENT '排序',
  `category_id` varchar(100) DEFAULT NULL COMMENT '分类ID集合',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=140 DEFAULT CHARSET=utf8;
```



商品SPU表：`spu`

```sql
CREATE TABLE `spu` (
  `id` varchar(60) NOT NULL COMMENT '主键',
  `name` varchar(100) DEFAULT NULL COMMENT 'SPU名',
  `intro` varchar(200) DEFAULT NULL COMMENT '商品简介',
  `brand_id` int(11) DEFAULT NULL COMMENT '品牌ID',
  `category_one_id` int(20) DEFAULT NULL COMMENT '一级分类',
  `category_two_id` int(10) DEFAULT NULL COMMENT '二级分类',
  `category_three_id` int(10) DEFAULT NULL COMMENT '三级分类',
  `images` varchar(1000) DEFAULT NULL COMMENT '图片列表',
  `after_sales_service` varchar(50) DEFAULT NULL COMMENT '售后服务',
  `content` longtext COMMENT '介绍',
  `attribute_list` varchar(3000) DEFAULT NULL COMMENT '规格列表',
  `is_marketable` int(1) DEFAULT '0' COMMENT '是否上架,0已下架，1已上架',
  `is_delete` int(1) DEFAULT '0' COMMENT '是否删除,0:未删除，1：已删除',
  `status` int(1) DEFAULT '0' COMMENT '审核状态，0：未审核，1：已审核，2：审核不通过',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
```



商品SKU表：`sku`

```sql
CREATE TABLE `sku` (
  `id` varchar(60) NOT NULL COMMENT '商品id',
  `name` varchar(200) NOT NULL COMMENT 'SKU名称',
  `price` int(20) NOT NULL DEFAULT '1' COMMENT '价格（分）',
  `num` int(10) DEFAULT '100' COMMENT '库存数量',
  `image` varchar(200) DEFAULT NULL COMMENT '商品图片',
  `images` varchar(2000) DEFAULT NULL COMMENT '商品图片列表',
  `create_time` datetime DEFAULT NULL COMMENT '创建时间',
  `update_time` datetime DEFAULT NULL COMMENT '更新时间',
  `spu_id` varchar(60) DEFAULT NULL COMMENT 'SPUID',
  `category_id` int(10) DEFAULT NULL COMMENT '类目ID',
  `category_name` varchar(200) DEFAULT NULL COMMENT '类目名称',
  `brand_name` varchar(100) DEFAULT NULL COMMENT '品牌名称',
  `sku_attribute` varchar(200) DEFAULT NULL COMMENT '规格',
  `status` int(1) DEFAULT '1' COMMENT '商品状态 1-正常，2-下架，3-删除',
  PRIMARY KEY (`id`),
  KEY `cid` (`category_id`),
  KEY `status` (`status`),
  KEY `updated` (`update_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='商品表';
```



### 4.2 订单数据库

订单表：`order`

```sql
CREATE TABLE `order` (
  `id` varchar(50) COLLATE utf8_bin NOT NULL COMMENT '订单id',
  `total_num` int(11) DEFAULT NULL COMMENT '数量合计',
  `moneys` int(11) DEFAULT NULL COMMENT '金额合计',
  `pay_type` varchar(1) COLLATE utf8_bin DEFAULT NULL COMMENT '支付类型，1、在线支付、0 货到付款',
  `create_time` datetime DEFAULT NULL COMMENT '订单创建时间',
  `update_time` datetime DEFAULT NULL COMMENT '订单更新时间',
  `pay_time` datetime DEFAULT NULL COMMENT '付款时间',
  `consign_time` datetime DEFAULT NULL COMMENT '发货时间',
  `end_time` datetime DEFAULT NULL COMMENT '交易完成时间',
  `username` varchar(50) COLLATE utf8_bin DEFAULT NULL COMMENT '用户名称',
  `recipients` varchar(50) COLLATE utf8_bin DEFAULT NULL COMMENT '收货人',
  `recipients_mobile` varchar(12) COLLATE utf8_bin DEFAULT NULL COMMENT '收货人手机',
  `recipients_address` varchar(200) COLLATE utf8_bin DEFAULT NULL COMMENT '收货人地址',
  `weixin_transaction_id` varchar(30) COLLATE utf8_bin DEFAULT NULL COMMENT '交易流水号',
  `order_status` int(1) COLLATE utf8_bin DEFAULT NULL COMMENT '订单状态,0:未完成,1:已完成，2：已退货',
  `pay_status` int(1) COLLATE utf8_bin DEFAULT NULL COMMENT '支付状态,0:未支付，1：已支付，2：支付失败',
  `is_delete` int(1) COLLATE utf8_bin DEFAULT NULL COMMENT '是否删除',
  PRIMARY KEY (`id`),
  KEY `create_time` (`create_time`),
  KEY `status` (`order_status`),
  KEY `payment_type` (`pay_type`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin;
```



订单明细表：`order_sku`

```sql
CREATE TABLE `order_sku` (
  `id` varchar(50) COLLATE utf8_bin NOT NULL COMMENT 'ID',
  `category_one_id` int(11) DEFAULT NULL COMMENT '1级分类',
  `category_two_id` int(11) DEFAULT NULL COMMENT '2级分类',
  `category_three_id` int(11) DEFAULT NULL COMMENT '3级分类',
  `spu_id` varchar(60) COLLATE utf8_bin DEFAULT NULL COMMENT 'SPU_ID',
  `sku_id` varchar(60) COLLATE utf8_bin DEFAULT NULL COMMENT 'SKU_ID',
  `order_id` varchar(50) COLLATE utf8_bin NOT NULL COMMENT '订单ID',
  `name` varchar(200) COLLATE utf8_bin DEFAULT NULL COMMENT '商品名称',
  `price` int(20) DEFAULT NULL COMMENT '单价',
  `num` int(10) DEFAULT NULL COMMENT '数量',
  `money` int(20) DEFAULT NULL COMMENT '总金额',
  `image` varchar(200) COLLATE utf8_bin DEFAULT NULL COMMENT '图片地址',
  PRIMARY KEY (`id`),
  KEY `item_id` (`sku_id`),
  KEY `order_id` (`order_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin;
```



### 4.3 秒杀数据库

秒杀商品表：`seckill_goods`

```sql
CREATE TABLE `seckill_goods` (
  `id` varchar(60) NOT NULL,
  `sup_id` varchar(60) DEFAULT NULL COMMENT 'spu ID',
  `sku_id` varchar(60) DEFAULT NULL COMMENT 'sku ID',
  `name` varchar(100) DEFAULT NULL COMMENT '标题',
  `images` varchar(150) DEFAULT NULL COMMENT '商品图片',
  `price` int(20) DEFAULT NULL COMMENT '原价格',
  `seckill_price` double(20,0) DEFAULT NULL COMMENT '秒杀价格',
  `create_time` datetime DEFAULT NULL COMMENT '添加日期',
  `start_time` datetime DEFAULT NULL COMMENT '开始时间',
  `end_time` datetime DEFAULT NULL COMMENT '结束时间',
  `num` int(11) DEFAULT NULL COMMENT '秒杀商品数',
  `store_count` int(11) DEFAULT NULL COMMENT '剩余库存数',
  `content` varchar(2000) DEFAULT NULL COMMENT '描述',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
```



秒杀订单表：`seckill_order`

```sql
CREATE TABLE `seckill_order` (
  `id` varchar(60) NOT NULL COMMENT '主键',
  `seckill_goods_id` varchar(60) DEFAULT NULL COMMENT '秒杀商品ID',
  `money` int(10) DEFAULT NULL COMMENT '支付金额',
  `username` varchar(50) DEFAULT NULL COMMENT '用户',
  `create_time` datetime DEFAULT NULL COMMENT '创建时间',
  `pay_time` datetime DEFAULT NULL COMMENT '支付时间',
  `status` int(1) DEFAULT NULL COMMENT '状态，0未支付，1已支付',
  `weixin_transaction_id` varchar(30) DEFAULT NULL COMMENT '交易流水',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
```



### 4.4 用户数据库

省份表：`provinces`

```sql
CREATE TABLE `provinces` (
  `provinceid` varchar(20) NOT NULL COMMENT '省份ID',
  `province` varchar(50) NOT NULL COMMENT '省份名称',
  PRIMARY KEY (`provinceid`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='省份信息表';
```



城市表：`cities`

```sql
CREATE TABLE `cities` (
  `cityid` varchar(20) NOT NULL COMMENT '城市ID',
  `city` varchar(50) NOT NULL COMMENT '城市名称',
  `provinceid` varchar(20) NOT NULL COMMENT '省份ID',
  PRIMARY KEY (`cityid`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='行政区域地州市信息表';
```



区域表：`areas`

```sql
CREATE TABLE `areas` (
  `areaid` varchar(20) NOT NULL COMMENT '区域ID',
  `area` varchar(50) NOT NULL COMMENT '区域名称',
  `cityid` varchar(20) NOT NULL COMMENT '城市ID',
  PRIMARY KEY (`areaid`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='行政区域县区信息表';
```



收件信息表：`address`

```sql
CREATE TABLE `address` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `username` varchar(50) DEFAULT NULL COMMENT '用户名',
  `provinceid` varchar(20) DEFAULT NULL COMMENT '省',
  `cityid` varchar(20) DEFAULT NULL COMMENT '市',
  `areaid` varchar(20) DEFAULT NULL COMMENT '县/区',
  `phone` varchar(20) DEFAULT NULL COMMENT '电话',
  `address` varchar(200) DEFAULT NULL COMMENT '详细地址',
  `contact` varchar(50) DEFAULT NULL COMMENT '联系人',
  `is_default` int(1) DEFAULT NULL COMMENT '是否是默认 1默认 0否',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=66 DEFAULT CHARSET=utf8;
```



## 5 工程搭建

### 5.1 环境准备

这里需要用到数据库`MySQL`和注册中心`Nacos`，数据库和注册中心全部已经安装在了虚拟机中.

```properties
虚拟机ip:192.168.100.130

虚拟机账号:root

账号密码：gupao

数据库账号：root

数据库密码：123456

Nacos   url   http://192.168.100.130:8848/nacos
              账号：nacos
              密码：nacos
```



基于Docker安装Nacos：

```properties
docker run -d -p 8848:8848 -e MODE=standalone -v /opt/nacos/init.d/custom.properties:/home/nacos/init.d/custom.properties -v /opt/nacos/logs:/home/nacos/logs --restart always --name nacos nacos/nacos-server
```

安装好了后，访问http://192.168.100.130:8848/nacos               账号密码都是nacos



基于Docker安装MySQL：

```properties
docker run -di --name mysql -p 3306:3306 -e MYSQL_ROOT_PASSWORD=123456 mysql:5.7
```



### 5.2 工程结构分析

![1602816321830](images\1602816321830.png)



### 5.3 公共工程搭建

#### 5.3.1 父工程搭建

工程坐标：

```xml
<groupId>com.gupaoedu.vip.mall</groupId>
<artifactId>gupaoedu-vip-mall</artifactId>
<version>0.0.1-SNAPSHOT</version>
```



我们选择用Spring Initializr创建父工程。

![1602813519676](images\1602813519676.png)



![](images\1602813723622.png)



整理下pom.xml，在pom.xml中只留部分包，其他包是创建微服务时需要。

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>2.2.10.RELEASE</version>
        <relativePath/> <!-- lookup parent from repository -->
    </parent>
    <groupId>com.gupaoedu.vip.mall</groupId>
    <artifactId>gupaoedu-vip-mall</artifactId>
    <version>0.0.1-SNAPSHOT</version>
    <name>gupaoedu-vip-mall</name>
    <!--父工程-->
    <packaging>pom</packaging>
    <description>云商城</description>

    <properties>
        <java.version>1.8</java.version>
        <spring-cloud-alibaba.version>2.2.1.RELEASE</spring-cloud-alibaba.version>
    </properties>

    <dependencies>
        <!--lombok，方便创建Bean对象和日志操作-->
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <optional>true</optional>
        </dependency>

        <!--Test-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
            <exclusions>
                <exclusion>
                    <groupId>org.junit.vintage</groupId>
                    <artifactId>junit-vintage-engine</artifactId>
                </exclusion>
            </exclusions>
        </dependency>

        <!--热部署插件-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-devtools</artifactId>
            <scope>runtime</scope>
            <optional>true</optional>
        </dependency>
    </dependencies>

    <dependencyManagement>
        <dependencies>
            <!--alibaba-->
            <dependency>
                <groupId>com.alibaba.cloud</groupId>
                <artifactId>spring-cloud-alibaba-dependencies</artifactId>
                <version>${spring-cloud-alibaba.version}</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
        </dependencies>
    </dependencyManagement>

    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
            </plugin>
        </plugins>
    </build>
</project>
```



#### 5.3.2 子项目父工程创建

我们可以按照功能分类，给每类工程创建一个父工程，方便管理。

```properties
mall-api：存储所有数据库表对应的Bean和Feign接口
mall-gateway：存储所有微服务网关
mall-service：存储所有微服务工程
mall-util：存储公共工程
mall-web：存储所有和页面渲染有关的工程
```



mall-api的pom.xml：

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>gupaoedu-vip-mall</artifactId>
        <groupId>com.gupaoedu.vip.mall</groupId>
        <version>0.0.1-SNAPSHOT</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>
    <packaging>pom</packaging>
    <artifactId>mall-api</artifactId>
    <description>
        存放所有JavaBean和Feign接口
    </description>
</project>
```



mall-gateway的pom.xml:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>gupaoedu-vip-mall</artifactId>
        <groupId>com.gupaoedu.vip.mall</groupId>
        <version>0.0.1-SNAPSHOT</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>
    <packaging>pom</packaging>
    <artifactId>mall-gateway</artifactId>
    <description>
        存放微服网关集群
    </description>

</project>
```



mall-service的pom.xml:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>gupaoedu-vip-mall</artifactId>
        <groupId>com.gupaoedu.vip.mall</groupId>
        <version>0.0.1-SNAPSHOT</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>
    <packaging>pom</packaging>
    <artifactId>mall-service</artifactId>
    <description>所有的应用服务</description>
</project>
```



mall-util的pom.xml:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>gupaoedu-vip-mall</artifactId>
        <groupId>com.gupaoedu.vip.mall</groupId>
        <version>0.0.1-SNAPSHOT</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>
    <packaging>pom</packaging>
    <artifactId>mall-util</artifactId>
    <description>
        存放所有公共工程
    </description>
</project>
```



mall-web的pom.xml：

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>gupaoedu-vip-mall</artifactId>
        <groupId>com.gupaoedu.vip.mall</groupId>
        <version>0.0.1-SNAPSHOT</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>
    <packaging>pom</packaging>
    <artifactId>mall-web</artifactId>
    <description>
        存放所有和页面渲染有关的工程，不建议放在service中，所有service只提供基于RESTful的服务
    </description>
</project>
```



#### 5.3.3 公共工程创建

##### 5.3.3.1 公共依赖汇总

service中以后要创建微服务工程操作数据库，我们可以把所有service需要用到的包以及所有service需要初始化的对象放到一个独立的工程中，以后哪个工程要用，直接依赖即可。

在`mall-util`中创建`mall-service-dependency`，pom.xml依赖如下：

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>mall-util</artifactId>
        <groupId>com.gupaoedu.vip.mall</groupId>
        <version>0.0.1-SNAPSHOT</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>
    <artifactId>mall-service-dependency</artifactId>
    <description>
        所有service工程依赖的包汇总以及初始化工具包
    </description>

    <dependencies>
        <!--web包-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>

        <!--MyBatis Plus-->
        <dependency>
            <groupId>com.baomidou</groupId>
            <artifactId>mybatis-plus-boot-starter</artifactId>
            <version>3.3.2</version>
        </dependency>

        <!--MySQL-->
        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
            <scope>runtime</scope>
        </dependency>

        <!--Redis-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-redis</artifactId>
        </dependency>

        <!--Nacos-->
        <dependency>
            <groupId>com.alibaba.cloud</groupId>
            <artifactId>spring-cloud-starter-alibaba-nacos-config</artifactId>
        </dependency>
        <dependency>
            <groupId>com.alibaba.cloud</groupId>
            <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
        </dependency>
    </dependencies>
</project>
```



##### 5.3.3.2 公共工具包

我们需要用到的工具包也可以单独放到一个工程中，每次要用，直接依赖即可。

在`mall-util`中创建`mall-common`，我们在工程中创建2个对象：

用于指定响应状态码的枚举对象：`com.gupaoedu.mall.util.RespCode`

```java
public enum RespCode {

    SUCCESS(20000, "操作成功"),
    ERROR(50000, "操作失败"),
    SYSTEM_ERROR(50001, "系统错误");

    private Integer code;
    private String message;

    RespCode(Integer code, String message) {
        this.code = code;
        this.message = message;
    }
    RespCode() {
    }
    public Integer getCode() {
        return code;
    }

    public void setCode(Integer code) {
        this.code = code;
    }

    public String getMessage() {
        return message;
    }

    public void setMessage(String message) {
        this.message = message;
    }
}
```



用于响应用户信息封装的对象:`com.gupaoedu.mall.util.RespResult`

```java
public class RespResult<T> implements Serializable {

    //响应数据结果集
    private T data;

    /**
     * 状态码
     * 20000 操作成功
     * 50000 操作失败
     */
    private Integer code;

    /***
     * 响应信息
     */
    private String message;

    public RespResult() {
    }

    public RespResult(RespCode resultCode) {
        this.code = resultCode.getCode();
        this.message = resultCode.getMessage();
    }

    public RespResult(T data, RespCode resultCode) {
        this.data = data;
        this.code = resultCode.getCode();
        this.message = resultCode.getMessage();
    }
    public static RespResult ok() {
        return new RespResult(null, RespCode.SUCCESS);
    }

    public static RespResult ok(Object data) {
        return new RespResult(data, RespCode.SUCCESS);
    }

    public static RespResult error() {
        return new RespResult(null, RespCode.ERROR);
    }

    public static RespResult error(String message) {
        return secByError(RespCode.ERROR.getCode(),message);
    }

    //自定义异常
    public static RespResult secByError(Integer code,String message) {
        RespResult err = new RespResult();
        err.setCode(code);
        err.setMessage(message);
        return err;
    }

    public static RespResult error(RespCode resultCode) {
        return new RespResult(resultCode);
    }

    public T getData() {
        return data;
    }

    public void setData(T data) {
        this.data = data;
    }

    public Integer getCode() {
        return code;
    }

    public void setCode(Integer code) {
        this.code = code;
    }

    public String getMessage() {
        return message;
    }

    public void setMessage(String message) {
        this.message = message;
    }
}
```





##### 5.3.3.3 依赖管理

service工程一定会依赖`mall-service-dependency`和`mall-common`，我们可以修改`mall-service`将这两个工程添加到依赖中：

```xml
<dependencies>
    <!--依赖mall-service-dependency-->
    <dependency>
        <groupId>com.gupaoedu.vip.mall</groupId>
        <artifactId>mall-service-dependency</artifactId>
        <version>0.0.1-SNAPSHOT</version>
    </dependency>

    <!--依赖mall-common-->
    <dependency>
        <groupId>com.gupaoedu.vip.mall</groupId>
        <artifactId>mall-common</artifactId>
        <version>0.0.1-SNAPSHOT</version>
    </dependency>
</dependencies>
```





## 6 品牌管理实现

### 6.1 集成MyBatisPlus

#### 6.1.1 MyBatis Plus介绍

[MyBatis-Plus](https://github.com/baomidou/mybatis-plus)（简称 MP）是一个 [MyBatis](http://www.mybatis.org/mybatis-3/) 的增强工具，在 MyBatis 的基础上只做增强不做改变，为简化开发、提高效率而生。



**MyBatis Plus特性：**

- **无侵入**：只做增强不做改变，引入它不会对现有工程产生影响，如丝般顺滑
- **损耗小**：启动即会自动注入基本 CURD，性能基本无损耗，直接面向对象操作
- **强大的 CRUD 操作**：内置通用 Mapper、通用 Service，仅仅通过少量配置即可实现单表大部分 CRUD 操作，更有强大的条件构造器，满足各类使用需求
- **支持 Lambda 形式调用**：通过 Lambda 表达式，方便的编写各类查询条件，无需再担心字段写错
- **支持主键自动生成**：支持多达 4 种主键策略（内含分布式唯一 ID 生成器 - Sequence），可自由配置，完美解决主键问题
- **支持 ActiveRecord 模式**：支持 ActiveRecord 形式调用，实体类只需继承 Model 类即可进行强大的 CRUD 操作
- **支持自定义全局通用操作**：支持全局通用方法注入（ Write once, use anywhere ）
- **内置代码生成器**：采用代码或者 Maven 插件可快速生成 Mapper 、 Model 、 Service 、 Controller 层代码，支持模板引擎，更有超多自定义配置等您来使用
- **内置分页插件**：基于 MyBatis 物理分页，开发者无需关心具体操作，配置好插件之后，写分页等同于普通 List 查询
- **分页插件支持多种数据库**：支持 MySQL、MariaDB、Oracle、DB2、H2、HSQL、SQLite、Postgre、SQLServer 等多种数据库
- **内置性能分析插件**：可输出 Sql 语句以及其执行时间，建议开发测试时启用该功能，能快速揪出慢查询
- **内置全局拦截插件**：提供全表 delete 、 update 操作智能分析阻断，也可自定义拦截规则，预防误操作



**支持的数据库：**

- mysql 、mariadb 、oracle 、db2 、h2 、hsql 、sqlite 、postgresql 、sqlserver 、presto 、Gauss 、Firebird
- Phoenix 、clickhouse 、Sybase ASE 、 OceanBase 、达梦数据库 、虚谷数据库 、人大金仓数据库 、南大通用数据库 、





#### 6.1.2 MyBatisPlus集成

1)引入依赖包

在`mall-service-dependency`中引入如下依赖(**这个依赖包之前已经引入了，这里无需再次引入**)：

```xml
<!--MyBatis Plus-->
<dependency>
    <groupId>com.baomidou</groupId>
    <artifactId>mybatis-plus-boot-starter</artifactId>
    <version>3.3.2</version>
</dependency>
```



在`mall-api`中引入如下依赖(**编写JavaBean会用到MyBatis Plus的相关注解，引入依赖防止程序编译不通过**)：

```xml
<!--MyBatis Plus-->
<dependency>
    <groupId>com.baomidou</groupId>
    <artifactId>mybatis-plus-boot-starter</artifactId>
    <version>3.3.2</version>
    <scope>provided</scope>
</dependency>
```



2)创建`goods-api`工程

在`mall-api`中创建子工程`goods-api`，用于创建`shop_goods`数据库表对应的实体Bean和Feign接口。

pom.xml:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>mall-api</artifactId>
        <groupId>com.gupaoedu.vip.mall</groupId>
        <version>0.0.1-SNAPSHOT</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>
    <artifactId>goods-api</artifactId>
    <description>
        shop_goods数据库表对应的JavaBean
    </description>
</project>
```



在`goods-api`中创建`com.gupaoedu.vip.mall.goods.Brand`，代码如下：

```java
@Data
@AllArgsConstructor
@NoArgsConstructor
//MyBatisPlus表映射注解
@TableName(value = "brand")
public class Brand implements Serializable {
    //    品牌ID
    //    MyBatisPlus主键策略注解
    @TableId(type=IdType.AUTO)
    private Integer id;
    //    品牌名字
    private String name;
    //    品牌图片
    private String image;
    //    品牌首字母
    private String initial;
    //    品牌排序
    private Integer sort;
}
```



主键生成策略

| AUTO          | 数据库ID自增                                                 |
| ------------- | ------------------------------------------------------------ |
| NONE          | 无状态,该类型为未设置主键类型(注解里等于跟随全局,全局里约等于 INPUT) |
| INPUT         | insert前自行set主键值                                        |
| ASSIGN_ID     | 分配ID(主键类型为Number(Long和Integer)或String)(since 3.3.0),使用接口`IdentifierGenerator`的方法`nextId`(默认实现类为`DefaultIdentifierGenerator`雪花算法) |
| ASSIGN_UUID   | 分配UUID,主键类型为String(since 3.3.0),使用接口`IdentifierGenerator`的方法`nextUUID`(默认default方法) |
| ID_WORKER     | 分布式全局唯一ID 长整型类型(please use `ASSIGN_ID`)   ，已过时 |
| UUID          | 32位UUID字符串(please use `ASSIGN_UUID`)    ，已过时         |
| ID_WORKER_STR | 分布式全局唯一ID 字符串类型(please use `ASSIGN_ID`)    ，已过时 |



3)商品微服务

在`mall-service`中创建`mall-goods-service`微服务，用于操作`shop_goods`数据库。

pom.xml代码如下：

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>mall-service</artifactId>
        <groupId>com.gupaoedu.vip.mall</groupId>
        <version>0.0.1-SNAPSHOT</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>
    <artifactId>mall-goods-service</artifactId>
    <description>
        shop_goods微服务
    </description>

    <dependencies>
        <!--goods-api依赖-->
        <dependency>
            <groupId>com.gupaoedu.vip.mall</groupId>
            <artifactId>goods-api</artifactId>
            <version>0.0.1-SNAPSHOT</version>
        </dependency>
    </dependencies>
</project>
```



创建`bootstrap.yml`，配置如下：

```yaml
server:
  port: 8081
spring:
  application:
    name: mall-goods
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://192.168.100.130:3306/shop_goods?useUnicode=true&characterEncoding=UTF-8&serverTimezone=UTC
    username: root
    password: 123456
  cloud:
    nacos:
      config:
        file-extension: yaml
        server-addr: 192.168.100.130:8848
      discovery:
        #Nacos的注册地址
        server-addr: 192.168.100.130:8848
# ====================MybatisPlus====================
mybatis-plus:
  mapper-locations: mapper/*.xml
  type-aliases-package: com.gupaoedu.vip.mall.*.model
  configuration:
    map-underscore-to-camel-case: true
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl

#日志配置
logging:
  pattern:
    console: "%msg%n"
```

配置说明：

```properties
type-aliases-package:指定JavaBean的别名包，和MyBatis用法一样。
mapper-locations:复杂的操作可能需要自己写SQL，SQL可以写到xml文件中，这里指定和Dao对应的xml文件，此时我们需要在resources中创建一个mapper目录。
map-underscore-to-camel-case:开启驼峰功能，数据库表列名如果有_，可以自动按驼峰命名规则转换。
log-impl:日志开启，方便测试。
```



创建启动类`com.gupaoedu.vip.mall.MallGoodsServiceApplication`：

```java
@SpringBootApplication
@MapperScan(basePackages = {"com.gupaoedu.vip.mall.goods.mapper"})
public class MallGoodsServiceApplication {

    public static void main(String[] args) {
        SpringApplication.run(MallGoodsServiceApplication.class,args);
    }
}
```



此时启动程序，查看Nacos控制台：<http://192.168.100.130:8848/nacos>  账号和密码都是nacos，效果如下：

![1602843611271](images\1602843611271.png)



### 6.2 MyBatisPlus操作案例

我们创建一个品牌操作的功能，实现品牌增删改查，分别创建`model`、`mapper`、`service`、`controller`。

MyBatisPlus提供了很多通用方法：

```properties
mapper(接口)->extends BaseMapper【增删改查】
service(接口)->extends IService【增删改查】
serviceImpl->extends ServiceImpl【增删改查】
```



#### 6.2.1 Mapper创建

在`mall-goods-service`创建`com.gupaoedu.vip.mall.goods.mapper.BrandMapper`接口，代码如下：

```java
public interface BrandMapper extends BaseMapper<Brand> {
}
```

代码说明：BaseMapper中已经存在了很多常见数据库操作方法，可以大幅提升开发速度。



#### 6.2.2 Service创建

在`mall-goods-service`创建`com.gupaoedu.vip.mall.goods.service.BrandService`接口，代码如下：

```java
public interface BrandService extends IService<Brand>{
}
```



在`mall-goods-service`创建`com.gupaoedu.vip.mall.goods.service.impl.BrandServiceImpl`实现类，代码如下：

```java
@Service
public class BrandServiceImpl extends ServiceImpl<BrandMapper,Brand> implements BrandService {}
```

代码说明：`IService`和`ServiceImpl`中已经创建好了很多常用的增删改查方法，我们写常用的增删改查，几乎不用写方法。



#### 6.2.3 增删改功能

增删改功能在`IService`和`ServiceImpl`中已经全部存在， 不需要额外添加方法，只需要在Controller调用即可。

在`mall-goods-service`创建`com.gupaoedu.vip.mall.goods.controller.BrandController`，代码如下：

```java
@RestController
@RequestMapping(value = "/brand")
public class BrandController {

    @Autowired
    private BrandService brandService;

    /***
     * 增加品牌
     */
    @PostMapping
    public RespResult add(@RequestBody Brand brand){
        // 增加品牌
        brandService.save(brand);
        return RespResult.ok();
    }

    /****
     * 修改
     */
    @PutMapping
    public RespResult update(@RequestBody Brand brand){
        //修改品牌
        brandService.updateById(brand);
        return RespResult.ok();
    }

    /****
     * 删除品牌
     */
    @DeleteMapping("/{id}")
    public RespResult delete(@PathVariable(value = "id") Integer id){
        //删除品牌
        brandService.removeById(id);
        return RespResult.ok();
    }
}
```



#### 6.2.4 条件查询/分页

条件查询需要封装条件信息，MyBatis Plus提供了条件封装对象`Wrapper`（它的子类`QueryWrapper`可以直接使用），我们可以用它的子类`QueryWrapper`实现封装查询条件。



##### 6.2.4.1 条件查询

在`BrandService`中创建如下方法：

```
List<Brand> queryList(Brand brand);
```



在`BrandServiceImpl`中创建条件查询方法实现(不要忘了注入`brandMapper`)：

```java
/****
 * 多条件查询
 * @param brand
 * @return
 */
@Override
public List<Brand> queryList(Brand brand) {
    // 多条件构造器
    QueryWrapper<Brand> queryWrapper = new QueryWrapper<Brand>();
    if(!StringUtils.isEmpty(brand.getName())){
        queryWrapper.like("name",brand.getName());
    }
    if(!StringUtils.isEmpty(brand.getName())){
        queryWrapper.eq("initial",brand.getInitial());
    }
    return brandMapper.selectList(queryWrapper);
}
```



代码说明：

```
like:表示模糊查询
eq:表示等值查询
```



在`BrandController`中创建条件查询方法：

```java
/****
 * 条件查询
 */
@PostMapping(value = "/list")
public RespResult<List<Brand>> list(@RequestBody(required = false) Brand brand){
    // 查询
    List<Brand> brands = brandService.queryList(brand);
    return RespResult.ok(brands);
}
```





##### 6.2.4.2 分页查询

在`BrandService`中创建如下方法：

```
Page<Brand> queryPageList(Long currentPage,Long size,Brand brand);
```



在`BrandServiceImpl`中创建条件查询方法实现(不要忘了注入`brandMapper`)：

```java
/***
 * 分页查询
 * @param brand
 * @return
 */
@Override
public Page<Brand> queryPageList(Long currentPage, Long size, Brand brand) {
    // 封装查询条件
    Page<Brand> page = brandMapper.selectPage(
            new Page<Brand>(currentPage, size),
            new QueryWrapper<Brand>()
                    .like("name", brand.getName()));
    return page;
}
```



代码说明：

```
like:表示模糊查询
```



在`BrandController`中创建条件查询方法：

```java
/****
 * 条件分页查询
 */
@PostMapping(value = "/list/{page}/{size}")
public RespResult<Page<Brand>> list(
        @PathVariable(value = "page")Long currentPage,
        @PathVariable(value = "size")Long size,
        @RequestBody(required = false) Brand brand){
    // 分页查询
    Page<Brand> brandPage = brandService.queryPageList(currentPage,size,brand);
    return RespResult.ok(brandPage);
}
```



测试结果如下：

![1602843665909](images\1602843665909.png)







